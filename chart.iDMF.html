<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DMF integration chart</title>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script> -->
    <!-- <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script> -->

    <script src="js/d3.min.js"></script>
    <script src="js/d3.tip.v0.6.3.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css" media="screen">
    <link rel="stylesheet" href="css/bootswatch.min.css">
    <link rel="stylesheet" type="text/css" href="css/chart.css">
</head>
<body>

</body>
    <div class="container">
        <div class="page-header">
            <h1>DMF integration points</h1>
            <p class="lead">Documenting DMF's infrastructure since 2015.</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="chartviewport">
            </div>
        </div>
        <div class="col-md-4">.
            <div class="textviewport">
            </div>
        </div>
    </div>

    <script>

        var width = 960,
                height = 700,
                radius = Math.min(width, height) / 2;

        var x = d3.scale.linear()
                .range([0, 2 * Math.PI]);

        var y = d3.scale.sqrt()
                .range([0, radius]);

        var color = d3.scale.category20c();

        var svg = d3.select(".chartviewport").append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width / 2 + "," + (height / 2 + 10) + ")");

        var partition = d3.layout.partition()
                .value(function (d) {
                    return d.size;
                });

        var arc = d3.svg.arc()
                .startAngle(function (d) {
                    return Math.max(0, Math.min(2 * Math.PI, x(d.x)));
                })
                .endAngle(function (d) {
                    return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx)));
                })
                .innerRadius(function (d) {
                    return Math.max(0, y(d.y));
                })
                .outerRadius(function (d) {
                    return Math.max(0, y(d.y + d.dy));
                });

        var tip = d3.tip()
                .attr('class', 'd3-tip')
                .offset([-10, 0])
                .html(function (d) {
                    return "<span style='color:green'>" + d.name + "</span>";
                });

        svg.call(tip);

        d3.json("data/dmf2.json", function(error, root){
            if (error) throw(error);

            var path = svg.selectAll("path")
                    .data(partition.nodes(root))
                    .enter().append("path")
                    .attr("d", arc)
                    .style("fill", function (d) {
                        return d.new ? "green" : color((d.children ? d : d.parent).name);
                    })
                    .on("click", click)
                    .on('mouseover', tip.show)
                    .on('mouseout', tip.hide);

            function click(d) {
                path.transition()
                        .duration(750)
                        .attrTween("d", arcTween(d));
            }
        });


        //d3.select(self.frameElement).style("height", height + "px");

        // Interpolate the scales!
        function arcTween(d) {
            var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
                    yd = d3.interpolate(y.domain(), [d.y, 1]),
                    yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
            return function (d, i) {
                return i ? function (t) {
                    return arc(d);
                } : function (t) {
                    x.domain(xd(t));
                    y.domain(yd(t)).range(yr(t));
                    return arc(d);
                };
            };
        }
    </script>
</html>